---
/**
 * 忘记密码页面 - 与 Next.js/Vue.js 版本保持一致的设计
 */
import AuthLayout from '../../layouts/AuthLayout.astro';

const brandName = import.meta.env.PUBLIC_BRAND_NAME || 'Admin Pro';
---

<AuthLayout title="忘记密码" showLeft={false}>
  <!-- 右侧忘记密码卡片 -->
  <div slot="right" class="w-full max-w-md animate-fade-in-up">
    <!-- Logo -->
    <div class="mb-5 text-center animate-fade-in-down">
      <div
        class="inline-flex items-center gap-3 mb-3 px-6 py-3 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-600 shadow-xl"
      >
        <svg
          class="h-6 w-6 text-white"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M12 3l1.912 5.813a2 2 0 001.272 1.272L21 12l-5.813 1.912a2 2 0 00-1.272 1.272L12 21l-1.912-5.813a2 2 0 00-1.272-1.272L3 12l5.813-1.912a2 2 0 001.272-1.272L12 3z"
          ></path>
        </svg>
        <span class="text-xl font-bold text-white">{brandName}</span>
      </div>
    </div>

    <!-- 卡片容器 -->
    <div
      class="border border-gray-200/50 dark:border-gray-700/50 shadow-2xl backdrop-blur-xl bg-white/80 dark:bg-gray-900/80 rounded-2xl overflow-hidden"
    >
      <!-- 渐变顶部条 -->
      <div class="h-1 bg-gradient-to-r from-blue-600 via-indigo-600 to-violet-600"></div>

      <!-- 卡片头部 -->
      <div class="text-center pb-3 sm:pb-5 pt-6 sm:pt-8 px-4 sm:px-6">
        <div
          class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-50 dark:bg-blue-900/30 mb-4 animate-scale-in"
        >
          <svg
            class="h-8 w-8 text-blue-600 dark:text-blue-400"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0110 0v4"></path>
          </svg>
        </div>
        <h1
          class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent"
        >
          忘记密码
        </h1>
        <p class="text-xs sm:text-sm mt-2 text-gray-500 dark:text-gray-400">
          输入您的邮箱地址，我们将发送重置密码链接
        </p>
      </div>

      <!-- 卡片内容 -->
      <div class="space-y-4 px-4 sm:px-6 pb-6">
        <!-- 错误提示 -->
        <div
          id="error-message"
          class="hidden p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 text-xs sm:text-sm animate-shake"
        >
        </div>

        <!-- 忘记密码表单 -->
        <form id="forgot-password-form" class="space-y-4">
          <!-- 邮箱输入 -->
          <div class="space-y-2 animate-fade-in-up" style="animation-delay: 0.1s;">
            <label for="email" class="text-xs font-medium text-gray-500 dark:text-gray-400"
              >邮箱地址</label
            >
            <div class="relative group">
              <svg
                class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-blue-600 transition-colors z-10"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                ></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <input
                type="email"
                id="email"
                name="email"
                class="w-full pl-10 pr-4 h-12 text-sm border border-gray-200/50 dark:border-gray-700/50 focus:border-blue-500/50 rounded-xl transition-all bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400"
                placeholder="请输入注册时使用的邮箱"
                required
              />
            </div>
          </div>

          <!-- 提交按钮 -->
          <div class="animate-fade-in-up" style="animation-delay: 0.2s;">
            <button
              type="submit"
              id="submit-btn"
              class="w-full h-12 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2"
            >
              <span id="btn-text">发送重置链接</span>
              <span id="btn-arrow" class="animate-arrow-bounce">→</span>
              <svg
                id="btn-loading"
                class="hidden h-4 w-4 animate-spin"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 12a9 9 0 11-6.219-8.56"></path>
              </svg>
            </button>
          </div>
        </form>

        <!-- 成功提示（默认隐藏） -->
        <div
          id="success-message"
          class="hidden p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 animate-fade-in-up"
        >
          <div class="flex items-center gap-3">
            <div
              class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-green-600 dark:text-green-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-green-800 dark:text-green-200">邮件已发送</p>
              <p class="text-xs text-green-700 dark:text-green-300">请检查您的邮箱并点击重置链接</p>
            </div>
          </div>
        </div>

        <!-- 返回登录 -->
        <div class="text-center pt-2 animate-fade-in-up" style="animation-delay: 0.3s;">
          <a
            href="/auth/login"
            class="inline-flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            返回登录
          </a>
        </div>
      </div>
    </div>
  </div>
</AuthLayout>

<script>
  const form = document.getElementById('forgot-password-form') as HTMLFormElement;
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnArrow = document.getElementById('btn-arrow');
  const btnLoading = document.getElementById('btn-loading');

  // 显示错误
  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      errorMessage.classList.remove('animate-shake');
      void errorMessage.offsetWidth;
      errorMessage.classList.add('animate-shake');
    }
  }

  // 设置加载状态
  function setLoading(loading: boolean) {
    if (submitBtn) submitBtn.disabled = loading;
    if (btnText) btnText.textContent = loading ? '发送中...' : '发送重置链接';
    btnArrow?.classList.toggle('hidden', loading);
    btnLoading?.classList.toggle('hidden', !loading);
    submitBtn?.classList.toggle('opacity-70', loading);
    submitBtn?.classList.toggle('cursor-not-allowed', loading);
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;

    if (!email) {
      showError('请输入邮箱地址');
      return;
    }

    setLoading(true);

    try {
      const _response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      // 无论成功与否都显示成功消息（安全考虑）
      form.classList.add('hidden');
      successMessage?.classList.remove('hidden');
    } catch (_error) {
      // 开发模式下直接显示成功
      form.classList.add('hidden');
      successMessage?.classList.remove('hidden');
    }
  });
</script>
