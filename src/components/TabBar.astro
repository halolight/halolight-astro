---
/**
 * TabBar Component
 * Multi-tab navigation bar with closable tabs
 */
import type { Tab as _Tab } from '../lib/tabs-store';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div
  id="tab-bar"
  class:list={[
    'sticky top-16 z-20 border-b border-gray-200 dark:border-gray-700',
    'bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm',
    'transition-all duration-300',
    'hidden',
    className,
  ]}
>
  <div class="flex overflow-x-auto scrollbar-hide px-4 py-2 gap-1">
    <!-- Tabs will be rendered here by client script -->
    <div id="tabs-container" class="flex gap-1"></div>
  </div>
</div>

<script>
  import { loadTabsState, removeTab, setActiveTab, type Tab } from '../lib/tabs-store';
  import { loadUiSettings } from '../lib/ui-settings';

  function renderTabs() {
    const tabBar = document.getElementById('tab-bar');
    const container = document.getElementById('tabs-container');
    if (!tabBar || !container) return;

    // Check if tab bar should be visible
    const settings = loadUiSettings();
    if (!settings.showTabBar) {
      tabBar.classList.add('hidden');
      return;
    } else {
      tabBar.classList.remove('hidden');
    }

    // Load tabs state
    const state = loadTabsState();
    const tabs = state.tabs;
    const activeId = state.activeTabId;

    // Clear container
    container.innerHTML = '';

    // Render each tab
    tabs.forEach((tab: Tab) => {
      const tabElement = document.createElement('button');
      tabElement.className = `
        flex items-center gap-2 px-3 py-1.5 rounded-md text-sm
        transition-colors duration-200
        ${
          tab.id === activeId
            ? 'bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
        }
      `.trim();

      // Tab title
      const titleSpan = document.createElement('span');
      titleSpan.textContent = tab.title || tab.path;
      titleSpan.className = 'whitespace-nowrap';
      tabElement.appendChild(titleSpan);

      // Close button (if closable)
      if (tab.closable !== false) {
        const closeBtn = document.createElement('button');
        closeBtn.className =
          'ml-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-0.5 transition-colors';
        closeBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        `;
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          removeTab(tab.id);

          // Reload to show updated tabs
          renderTabs();

          // Navigate to active tab if current tab was closed
          if (tab.id === activeId) {
            const updatedState = loadTabsState();
            const newActiveTab = updatedState.tabs.find((t) => t.id === updatedState.activeTabId);
            if (newActiveTab) {
              window.location.href = newActiveTab.path;
            }
          }
        };
        tabElement.appendChild(closeBtn);
      }

      // Click handler
      tabElement.onclick = () => {
        setActiveTab(tab.id);
        window.location.href = tab.path;
      };

      container.appendChild(tabElement);
    });
  }

  // Render tabs on page load
  renderTabs();

  // Re-render on storage change (for cross-tab sync)
  window.addEventListener('storage', (e) => {
    if (e.key === 'tabs-storage' || e.key === 'ui-settings-storage') {
      renderTabs();
    }
  });

  // Export render function for external use
  (window as unknown as Window & { renderTabs: () => void }).renderTabs = renderTabs;
</script>

<style>
  /* Custom scrollbar for tab overflow */
  #tab-bar {
    -webkit-overflow-scrolling: touch;
  }

  #tabs-container {
    min-width: 100%;
  }

  /* Smooth scroll behavior */
  #tab-bar::-webkit-scrollbar {
    height: 4px;
  }

  #tab-bar::-webkit-scrollbar-track {
    background: transparent;
  }

  #tab-bar::-webkit-scrollbar-thumb {
    background: hsl(var(--muted-foreground) / 0.3);
    border-radius: 2px;
  }

  #tab-bar::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--muted-foreground) / 0.5);
  }
</style>
